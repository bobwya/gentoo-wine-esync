--- a/0024-server-ntdll-Also-wait-on-the-queue-fd-when-waiting-.patch	2018-11-01 17:19:43.000000000 +0000
+++ b/0024-server-ntdll-Also-wait-on-the-queue-fd-when-waiting-.patch	2019-04-13 21:57:52.254454458 +0100
@@ -3,15 +3,12 @@
 Date: Sat, 9 Jun 2018 14:44:54 -0500
 Subject: [PATCH 24/83] server, ntdll: Also wait on the queue fd when waiting
  for driver events.
-
 Normally the server handles this, by polling on the fd during its main loop.
 The problem there is that the server only polls when the thread is waiting
 for messages. We want to replicate that behaviour, otherwise wineserver spins
 forever trying to wake up a thread that just doesn't care.
-
 With this patch, I'm finally able to interact with winecfg. Next step is to
 fix the 'drives' tab.
-
 Signed-off-by: Zebediah Figura <z.figura12@gmail.com>
 ---
  dlls/ntdll/esync.c             | 44 ++++++++++++++++++++++++----------
@@ -26,7 +23,6 @@
  server/thread.c                |  5 ++--
  server/trace.c                 |  7 +++++-
  11 files changed, 79 insertions(+), 25 deletions(-)
-
 diff --git a/dlls/ntdll/esync.c b/dlls/ntdll/esync.c
 index c4faf69a13..cb206bc0f5 100644
 --- a/dlls/ntdll/esync.c
@@ -105,13 +101,13 @@
          FIXME("Can't wait on esync and server objects at the same time!\n");
 @@ -491,6 +496,9 @@ NTSTATUS esync_wait_objects( DWORD count, const HANDLE *handles, BOOLEAN wait_an
          for (i = 0; i < count; i++)
-             DPRINTF(" %p", handles[i]);
+             TRACE(" %p", handles[i]);
  
 +        if (msgwait)
-+            DPRINTF(" or driver events (fd %d)", ntdll_get_thread_data()->esync_queue_fd);
++            TRACE(" or driver events (fd %d)", ntdll_get_thread_data()->esync_queue_fd);
 +
          if (!timeout)
-             DPRINTF(", timeout = INFINITE.\n");
+             TRACE(", timeout = INFINITE.\n");
          else
 @@ -508,10 +516,16 @@ NTSTATUS esync_wait_objects( DWORD count, const HANDLE *handles, BOOLEAN wait_an
              fds[i].fd = objs[i] ? objs[i]->fd : -1;
@@ -244,8 +240,9 @@
 index 6a40da5527..37238693b9 100644
 --- a/server/process.c
 +++ b/server/process.c
-@@ -65,7 +65,7 @@ static int process_signaled( struct object *obj, struct wait_queue_entry *entry
+@@ -65,8 +65,8 @@ static int process_signaled( struct object *obj, struct wait_queue_entry *entry
  static unsigned int process_map_access( struct object *obj, unsigned int access );
+ static struct security_descriptor *process_get_sd( struct object *obj );
  static void process_poll_event( struct fd *fd, int event );
  static void process_destroy( struct object *obj );
 -static int process_get_esync_fd( struct object *obj );
@@ -269,7 +266,7 @@
 index 250590573e..6ef953303b 100644
 --- a/server/protocol.def
 +++ b/server/protocol.def
-@@ -3870,4 +3870,14 @@ struct handle_info
+@@ -3983,6 +3983,16 @@ struct handle_info
  @REQ(get_esync_fd)
      obj_handle_t handle;        /* handle to the object */
  @REPLY
@@ -284,6 +281,8 @@
 +    ESYNC_MANUAL_SERVER,
 +    ESYNC_QUEUE,
 +};
+ 
+ 
 diff --git a/server/queue.c b/server/queue.c
 index 1a5bbc7e8c..b9aa4bc530 100644
 --- a/server/queue.c
@@ -327,9 +326,10 @@
 index 722c133847..56bef76c5f 100644
 --- a/server/thread.c
 +++ b/server/thread.c
-@@ -131,7 +131,7 @@ static const struct object_ops thread_apc_ops =
+@@ -131,8 +131,8 @@ static const struct object_ops thread_apc_ops =
  
  static void dump_thread( struct object *obj, int verbose );
+ static struct object_type *thread_get_type( struct object *obj );
  static int thread_signaled( struct object *obj, struct wait_queue_entry *entry );
 -static int thread_get_esync_fd( struct object *obj );
 +static int thread_get_esync_fd( struct object *obj, enum esync_type *type );
@@ -337,7 +337,7 @@
  static void thread_poll_event( struct fd *fd, int event );
  static void destroy_thread( struct object *obj );
 @@ -378,9 +378,10 @@ static int thread_signaled( struct object *obj, struct wait_queue_entry *entry )
-     return (mythread->state == TERMINATED);
+     return mythread->state == TERMINATED && !mythread->exit_poll;
  }
  
 -static int thread_get_esync_fd( struct object *obj )
@@ -375,4 +375,3 @@
  static const char * const req_names[REQ_NB_REQUESTS] = {
 -- 
 2.19.1
-
