--- a/0041-server-Allocate-shared-memory-segments-for-semaphore.patch	2018-11-01 17:19:43.000000000 +0000
+++ b/0041-server-Allocate-shared-memory-segments-for-semaphore.patch	2020-04-29 20:41:32.874360645 +0100
@@ -49,14 +49,6 @@
  };
  
  
-@@ -6615,6 +6619,6 @@ union generic_reply
-     struct get_esync_fd_reply get_esync_fd_reply;
- };
- 
--#define SERVER_PROTOCOL_VERSION 571
-+#define SERVER_PROTOCOL_VERSION 572
- 
- #endif /* __WINE_WINE_SERVER_PROTOCOL_H */
 diff --git a/server/esync.c b/server/esync.c
 index 399011ff0b..f1a46afc23 100644
 --- a/server/esync.c
@@ -106,8 +98,8 @@
 +{
 +    struct stat st;
 +
-+    if (stat( wine_get_config_dir(), &st ) == -1)
-+        fatal_error( "cannot stat %s\n", wine_get_config_dir() );
++    if (fstat( config_dir_fd, &st ) == -1)
++        fatal_error( "cannot stat config dir\n" );
 +
 +    if (st.st_ino != (unsigned long)st.st_ino)
 +        sprintf( shm_name, "/wine-%lx%08lx-esync", (unsigned long)((unsigned long long)st.st_ino >> 32), (unsigned long)st.st_ino );
@@ -197,9 +189,9 @@
  #include "thread.h"
  #include "request.h"
 +#include "esync.h"
- #include "wine/library.h"
  
  /* command-line options */
+ int debug_level = 0;
 @@ -141,6 +142,9 @@ int main( int argc, char *argv[] )
      sock_init();
      open_master_socket();
@@ -208,8 +200,8 @@
 +        esync_init();
 +
      if (debug_level) fprintf( stderr, "wineserver: starting (pid=%ld)\n", (long) getpid() );
+     set_current_time();
      init_signals();
-     init_directories();
 diff --git a/server/protocol.def b/server/protocol.def
 index f22f8ce761..8b36b58a3f 100644
 --- a/server/protocol.def
