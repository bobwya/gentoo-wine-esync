--- a/0017-server-Create-eventfd-file-descriptors-for-event-obj.patch	2018-11-01 17:19:43.000000000 +0000
+++ b/0017-server-Create-eventfd-file-descriptors-for-event-obj.patch	2019-11-12 22:02:36.656685195 +0000
@@ -3,18 +3,14 @@
 Date: Fri, 8 Jun 2018 21:01:24 -0500
 Subject: [PATCH 17/83] server: Create eventfd file descriptors for event
  objects.
-
 We still need this, since there are some events which the server signals.
-
 This lets system processes shut down.
-
 Signed-off-by: Zebediah Figura <z.figura12@gmail.com>
 ---
  server/esync.c |  8 ++++++++
  server/esync.h |  1 +
  server/event.c | 28 ++++++++++++++++++++++++++--
  3 files changed, 35 insertions(+), 2 deletions(-)
-
 diff --git a/server/esync.c b/server/esync.c
 index 2e93493af1..e933d289b4 100644
 --- a/server/esync.c
@@ -47,7 +43,7 @@
 index a85be8de3d..41b4d6e054 100644
 --- a/server/event.c
 +++ b/server/event.c
-@@ -35,20 +35,24 @@
+@@ -35,22 +35,26 @@
  #include "thread.h"
  #include "request.h"
  #include "security.h"
@@ -56,6 +52,7 @@
  struct event
  {
      struct object  obj;             /* object header */
+     struct list    kernel_object;   /* list of kernel object pointers */
      int            manual_reset;    /* is it a manual reset event? */
      int            signaled;        /* event has been signaled */
 +    int            esync_fd;        /* esync file descriptor */
@@ -68,6 +65,7 @@
  static void event_satisfied( struct object *obj, struct wait_queue_entry *entry );
  static unsigned int event_map_access( struct object *obj, unsigned int access );
  static int event_signal( struct object *obj, unsigned int access);
+ static struct list *event_get_kernel_obj_list( struct object *obj );
 +static void event_destroy( struct object *obj );
  
  static const struct object_ops event_ops =
@@ -81,9 +79,8 @@
      event_satisfied,           /* satisfied */
      event_signal,              /* signal */
      no_get_fd,                 /* get_fd */
-@@ -70,7 +74,7 @@ static const struct object_ops event_ops =
-     default_unlink_name,       /* unlink_name */
-     no_open_file,              /* open_file */
+@@ -72,6 +76,6 @@ static const struct object_ops event_ops =
+     event_get_kernel_obj_list, /* get_kernel_obj_list */
      no_close_handle,           /* close_handle */
 -    no_destroy                 /* destroy */
 +    event_destroy              /* destroy */
@@ -91,7 +88,7 @@
  
  
 @@ -121,6 +125,9 @@ struct event *create_event( struct object *root, const struct unicode_str *name,
-             /* initialize it if it didn't already exist */
+             list_init( &event->kernel_object );
              event->manual_reset = manual_reset;
              event->signaled     = initial_state;
 +
@@ -135,9 +132,8 @@
 +        close( event->esync_fd );
 +}
 +
- struct keyed_event *create_keyed_event( struct object *root, const struct unicode_str *name,
-                                         unsigned int attr, const struct security_descriptor *sd )
+ static struct list *event_get_kernel_obj_list( struct object *obj )
  {
+     struct event *event = (struct event *)obj;
 -- 
 2.19.1
-
