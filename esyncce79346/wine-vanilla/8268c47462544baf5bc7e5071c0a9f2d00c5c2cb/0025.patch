--- a/0025-server-Create-eventfd-descriptors-for-device-manager.patch	2018-11-01 17:19:43.000000000 +0000
+++ b/0025-server-Create-eventfd-descriptors-for-device-manager.patch	2020-04-12 23:48:15.169185243 +0100
@@ -3,19 +3,15 @@
 Date: Sat, 9 Jun 2018 15:39:37 -0500
 Subject: [PATCH 25/83] server: Create eventfd descriptors for device manager
  objects.
-
 We don't have to worry about synchronization here because
 wine_ntoskrnl_main_loop() is only ever called from one thread per winedevice
 process.
-
 This lets drivers like mountmgr finally work, and so winecfg can open the
 Drives tab.
-
 Signed-off-by: Zebediah Figura <z.figura12@gmail.com>
 ---
  server/device.c | 24 +++++++++++++++++++++++-
  1 file changed, 23 insertions(+), 1 deletion(-)
-
 diff --git a/server/device.c b/server/device.c
 index 94309ba112..5c13a839ab 100644
 --- a/server/device.c
@@ -28,11 +24,11 @@
  
  /* IRP object */
  
-@@ -88,10 +89,12 @@ struct device_manager
-     struct object          obj;           /* object header */
-     struct list            devices;       /* list of devices */
-     struct list            requests;      /* list of pending irps across all devices */
-+    int                    esync_fd;      /* esync file descriptor */
+@@ -96,10 +97,12 @@ struct device_manager
+     struct list            devices;        /* list of devices */
+     struct list            requests;       /* list of pending irps across all devices */
+     struct wine_rb_tree    kernel_objects; /* map of objects that have client side pointer associated */
++    int                    esync_fd;       /* esync file descriptor */
  };
  
  static void device_manager_dump( struct object *obj, int verbose );
@@ -82,22 +78,22 @@
 +        if (do_esync())
 +            close( manager->esync_fd );
      }
- }
  
-@@ -629,6 +645,9 @@ static struct device_manager *create_device_manager(void)
-     {
+     while ((ptr = list_head( &manager->requests )))
+@@ -637,6 +653,9 @@ static struct device_manager *create_device_manager(void)
          list_init( &manager->devices );
          list_init( &manager->requests );
+         wine_rb_init( &manager->kernel_objects, compare_kernel_object );
 +
 +        if (do_esync())
 +            manager->esync_fd = esync_create_fd( 0, 0 );
      }
      return manager;
  }
-@@ -735,6 +754,9 @@ DECL_HANDLER(get_next_device_request)
-             iosb->in_size = 0;
+@@ -743,6 +762,9 @@ DECL_HANDLER(get_next_device_request)
              list_remove( &irp->mgr_entry );
              list_init( &irp->mgr_entry );
+             if (!irp->file) release_object( irp ); /* no longer on manager queue */
 +
 +            if (do_esync() && list_empty( &manager->requests ))
 +                esync_clear( manager->esync_fd );
@@ -106,4 +102,3 @@
      else set_error( STATUS_PENDING );
 -- 
 2.19.1
-
